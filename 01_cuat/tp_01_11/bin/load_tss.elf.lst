     1                                  
     2                                  %include "inc/externs.h" 
     1                              <1> EXTERN kernel32_init
     2                              <1> EXTERN TASK1_LABEL
     3                              <1> EXTERN TASK3_LABEL
     4                              <1> EXTERN TASK2_LABEL
     5                              <1> EXTERN __TSS_KERNEL 
     6                              <1> EXTERN __PAGE_TABLES_PHY     
     7                              <1> EXTERN __FUNCTIONS_PHY       
     8                              <1> EXTERN __VIDEO_PHY           
     9                              <1> EXTERN __ISR_AND_KEYBOARD_PHY
    10                              <1> EXTERN __DATA_PHY            
    11                              <1> EXTERN __TABLE_KEYBOARD_PHY  
    12                              <1> EXTERN __KERNEL_32_PHY       
    13                              <1> EXTERN __TASK_1_TEXT_PHY     
    14                              <1> EXTERN __TASK_1_BSS_PHY      
    15                              <1> EXTERN __TASK_1_DATA_PHY     
    16                              <1> EXTERN __TASK_1_RODATA_PHY   
    17                              <1> EXTERN __STACK_START_32_PHY  
    18                              <1> EXTERN __STACK_END_32_PHY    
    19                              <1> EXTERN __STACK_TASK1_PHY
    20                              <1> EXTERN __TASK_1_STACK_END_PHY
    21                              <1> EXTERN __SYS_TABLES_IDT
    22                              <1> EXTERN __PAGE_TABLES_VMA
    23                              <1> EXTERN __VIDEO_VMA
    24                              <1> EXTERN __load_DTP_entry_rom
    25                              <1> EXTERN __load_TP_entry_rom
    26                              <1> EXTERN __DATA_VMA
    27                              <1> EXTERN __INIT_16_VMA
    28                              <1> EXTERN __INIT_32_VMA
    29                              <1> EXTERN __STACK_START_32_VMA
    30                              <1> EXTERN __FUNCTIONS_VMA
    31                              <1> EXTERN __SYS_TABLES_VMA
    32                              <1> EXTERN __DATA_VMA
    33                              <1> EXTERN __ISR_AND_KEYBOARD_VMA
    34                              <1> EXTERN __KERNEL_32_VMA
    35                              <1> EXTERN __TASK_1_BSS_VMA
    36                              <1> EXTERN __TASK_1_RODATA_VMA
    37                              <1> EXTERN __TASK_1_TEXT_VMA
    38                              <1> EXTERN __TASK_1_DATA_VMA
    39                              <1> EXTERN __TABLE_KEYBOARD_VMA
    40                              <1> EXTERN __TASK_1_RODATA_PHY
    41                              <1> EXTERN __STACK_TASK1_VMA
    42                              <1> EXTERN __STACK_START_32
    43                              <1> EXTERN __CR3_KERNEL
    44                              <1> EXTERN __CR3_TASK1
    45                              <1> EXTERN __CR3_TASK2
    46                              <1> EXTERN __CR3_TASK3
    47                              <1> EXTERN __CR3_TASK4
    48                              <1> EXTERN LOAD_CR3_ROM
    49                              <1> EXTERN set_dtp_pt_merged_rom
    50                              <1> EXTERN __SYS_TABLES_TSS_PHY
    51                              <1> EXTERN __SYS_TABLES_PAG_PHY
    52                              <1> EXTERN __SYS_TABLES_PAG_VMA
    53                              <1> EXTERN __SYS_TABLES_LMA
    54                              <1> EXTERN turn_on_paging
    55                              <1> EXTERN __INIT_32_LMA
    56                              <1> EXTERN __INIT_32_VMA
    57                              <1> EXTERN SYS_TABLES_TSS_VMA
    58                              <1> 
    59                              <1> EXTERN __SYS_TABLES_PHY      
    60                              <1> EXTERN __SYS_TABLES_TSS_PHY  
    61                              <1> EXTERN __SYS_TABLES_PAG_PHY  
    62                              <1> EXTERN __SYS_TABLES_PAG_T0_PH
    63                              <1> EXTERN __SYS_TABLES_PAG_T1_PH
    64                              <1> EXTERN __SYS_TABLES_PAG_T2_PH
    65                              <1> EXTERN __SYS_TABLES_PAG_T3_PH
    66                              <1> EXTERN __PAGE_TABLES_PHY     
    67                              <1> EXTERN __VIDEO_PHY           
    68                              <1> EXTERN __ISR_AND_KEYBOARD_PHY
    69                              <1> EXTERN __DATA_PHY            
    70                              <1> EXTERN __TABLE_KEYBOARD_PHY  
    71                              <1> EXTERN __KERNEL_32_PHY       
    72                              <1> EXTERN __FUNCTIONS_PHY       
    73                              <1> EXTERN __TASK_1_TEXT_PHY     
    74                              <1> EXTERN __TASK_1_BSS_PHY      
    75                              <1> EXTERN __TASK_1_DATA_PHY     
    76                              <1> EXTERN __TASK_1_RODATA_PHY   
    77                              <1> EXTERN __TASK_2_TEXT_PHY     
    78                              <1> EXTERN __TASK_2_BSS_PHY      
    79                              <1> EXTERN __TASK_2_DATA_PHY     
    80                              <1> EXTERN __TASK_2_RODATA_PHY   
    81                              <1> EXTERN __TASK_3_TEXT_PHY     
    82                              <1> EXTERN __TASK_3_BSS_PHY      
    83                              <1> EXTERN __TASK_3_DATA_PHY     
    84                              <1> EXTERN __TASK_3_RODATA_PHY   
    85                              <1> EXTERN __TASK_4_TEXT_PHY     
    86                              <1> EXTERN __TASK_4_BSS_PHY      
    87                              <1> EXTERN __TASK_4_DATA_PHY     
    88                              <1> EXTERN __TASK_4_RODATA_PHY   
    89                              <1> EXTERN __STACK_START_32_PHY  
    90                              <1> EXTERN __STACK_END_32_PHY    
    91                              <1> EXTERN __TASK_1_STACK_START_PHY
    92                              <1> EXTERN __TASK_1_STACK_PHY_END
    93                              <1> 
    94                              <1> EXTERN __STACK_KERNEL_PHY    
    95                              <1> EXTERN __STACK_KERNEL_PHY_END   
    96                              <1> EXTERN __STACK_TASK1_PHY     
    97                              <1> EXTERN __STACK_TASK1_PHY_END 
    98                              <1> EXTERN __STACK_TASK2_PHY     
    99                              <1> EXTERN __STACK_TASK2_PHY_END 
   100                              <1> EXTERN __STACK_TASK3_PHY     
   101                              <1> EXTERN __STACK_TASK3_PHY_END 
   102                              <1> EXTERN __STACK_TASK4_PHY     
   103                              <1> EXTERN __STACK_TASK4_PHY_END 
   104                              <1> EXTERN __SYS_TABLES_VMA      
   105                              <1> EXTERN __SYS_TABLES_IDT      
   106                              <1> EXTERN __SYS_TABLES_GDT      
   107                              <1> EXTERN __PAGE_TABLES_VMA     
   108                              <1> EXTERN __SYS_TABLES_TSS_VMA  
   109                              <1> EXTERN __SYS_TABLES_PAG_VMA  
   110                              <1> EXTERN __SYS_TABLES_PAG_T1_VM
   111                              <1> EXTERN __SYS_TABLES_PAG_T2_VM
   112                              <1> EXTERN __SYS_TABLES_PAG_T3_VM
   113                              <1> EXTERN __SYS_TABLES_PAG_T4_VM
   114                              <1> EXTERN __FUNCTIONS_VMA       
   115                              <1> EXTERN __VIDEO_VMA           
   116                              <1> EXTERN __ISR_AND_KEYBOARD_VMA
   117                              <1> EXTERN __DATA_VMA            
   118                              <1> EXTERN __TABLE_KEYBOARD_VMA  
   119                              <1> EXTERN __KERNEL_32_VMA       
   120                              <1> EXTERN __TASK_1_TEXT_VMA     
   121                              <1> EXTERN __TASK_1_BSS_VMA      
   122                              <1> EXTERN __TASK_1_DATA_VMA     
   123                              <1> EXTERN __TASK_1_RODATA_VMA   
   124                              <1> EXTERN __TASK_2_TEXT_VMA     
   125                              <1> EXTERN __TASK_2_BSS_VMA      
   126                              <1> EXTERN __TASK_2_DATA_VMA     
   127                              <1> EXTERN __TASK_2_RODATA_VMA   
   128                              <1> EXTERN __TASK_3_TEXT_VMA     
   129                              <1> EXTERN __TASK_3_BSS_VMA      
   130                              <1> EXTERN __TASK_3_DATA_VMA     
   131                              <1> EXTERN __TASK_3_RODATA_VMA   
   132                              <1> EXTERN __TASK_4_TEXT_VMA     
   133                              <1> EXTERN __TASK_4_BSS_VMA      
   134                              <1> EXTERN __TASK_4_DATA_VMA     
   135                              <1> EXTERN __TASK_4_RODATA_VMA   
   136                              <1> EXTERN __STACK_START_32      
   137                              <1> EXTERN __STACK_END_32        
   138                              <1> EXTERN __STACK_TASK1_VMA    
   139                              <1> EXTERN __STACK_TASK1_VMA_END
   140                              <1> EXTERN __STACK_TASK2_VMA    
   141                              <1> EXTERN __STACK_TASK2_VMA_END  
   142                              <1> EXTERN __STACK_TASK3_VMA    
   143                              <1> EXTERN __STACK_TASK3_VMA_END
   144                              <1> EXTERN __STACK_TASK4_VMA    
   145                              <1> EXTERN __STACK_TASK4_VMA_END
   146                              <1> EXTERN __INIT_16_VMA         
   147                              <1> EXTERN __INIT_32_VMA         
   148                              <1> EXTERN __FUNCTIONS_ROM_VMA   
   149                              <1> EXTERN __RESET_VMA           
     3                                  
     4                                  section .load_tss
     5                                  GLOBAL load_tss
     6                                  EXTERN __TSS_TASK1
     7                                  EXTERN __TSS_TASK2
     8                                  EXTERN __TSS_TASK3
     9                                  EXTERN __TSS_TASK4
    10                                  EXTERN TASK1_LABEL
    11                                  EXTERN TASK2_LABEL
    12                                  EXTERN TASK3_LABEL
    13                                  EXTERN TASK4_LABEL
    14                                  EXTERN kernel32_loop
    15                                  EXTERN DS_SEL
    16                                  EXTERN CS_SEL_32
    17                                  EXTERN TSS_SEL
    18                                  EXTERN __STACK_KERNEL_T1_PHY
    19                                  EXTERN __STACK_KERNEL_T1_VMA
    20                                  EXTERN __STACK_KERNEL_T2_PHY
    21                                  EXTERN __STACK_KERNEL_T2_VMA
    22                                  EXTERN __STACK_KERNEL_T3_PHY
    23                                  EXTERN __STACK_KERNEL_T3_VMA
    24                                  EXTERN __STACK_KERNEL_T4_PHY
    25                                  EXTERN __STACK_KERNEL_T4_VMA
    26                                  EFLAGS EQU 0x202
    27                                  
    28                                  load_tss:
    29                                  
    30                                  ;------------TSS TASK1------------
    31 00000000 B8[00000000]                mov eax, __TSS_TASK1
    32 00000005 C70000000000                mov [eax], dword(0) ; Previous task link
    33 0000000B C74004[00000000]            mov [eax+0x04], dword(__STACK_END_32) ;ESP0
    34 00000012 C74008[00000000]            mov [eax+0x08], dword(DS_SEL)   ;SS0                 
    35 00000019 C7400C00000000              mov [eax+0x0C], dword(0) ;ESP1
    36 00000020 C7401000000000              mov [eax+0x10], dword(0) ;SS1
    37 00000027 C74014[00000000]            mov [eax+0x14], dword(__STACK_TASK1_VMA_END) ;ESP2
    38 0000002E C74018[00000000]            mov [eax+0x18], dword(DS_SEL) ;SS2
    39 00000035 C7401C[00000000]            mov [eax+0x1C], dword(__CR3_TASK1);CR3
    40 0000003C C74020[00000000]            mov [eax+0x20], dword(TASK1_LABEL) ;EIP
    41 00000043 C7402402020000              mov [eax+0x24], dword(EFLAGS) ;EFLAGS
    42 0000004A C7402800000000              mov [eax+0x28], dword(0) ;EAX
    43 00000051 C7402C00000000              mov [eax+0x2C], dword(0) ;ECX
    44 00000058 C7403000000000              mov [eax+0x30], dword(0) ;EDX
    45 0000005F C7403400000000              mov [eax+0x34], dword(0) ;EBX
    46 00000066 C74038[00000000]            mov [eax+0x38], dword(__STACK_TASK1_VMA_END) ;ESP
    47 0000006D C7403C[00000000]            mov [eax+0x3C], dword(__STACK_TASK1_VMA_END)    ;EBP
    48 00000074 C7404000000000              mov [eax+0x40], dword(0) ;ESI
    49 0000007B C7404400000000              mov [eax+0x44], dword(0) ;EDI
    50 00000082 C74048[00000000]            mov [eax+0x48], dword(DS_SEL) ;ES
    51 00000089 C7404C[00000000]            mov [eax+0x4C], dword(CS_SEL_32) ;CS
    52 00000090 C74050[00000000]            mov [eax+0x50], dword(DS_SEL) ;SS
    53 00000097 C74054[00000000]            mov [eax+0x54], dword(DS_SEL) ;DS
    54 0000009E C74058[00000000]            mov [eax+0x58], dword(DS_SEL) ;FS
    55 000000A5 C7405C[00000000]            mov [eax+0x5C], dword(DS_SEL);GS
    56 000000AC C7406000000000              mov [eax+0x60], dword(0)   ;LDTR
    57 000000B3 C7406400000000              mov [eax+0x64], dword(0) ;Bitmap I/O
    58                                  
    59                                  ;------------TSS TASK2------------
    60 000000BA B8[00000000]               mov eax, __TSS_TASK2
    61 000000BF C70000000000                mov [eax], dword(0) ;
    62 000000C5 C74004[00000000]            mov [eax+0x04], dword(__STACK_END_32) ;ESP0
    63 000000CC C74008[00000000]            mov [eax+0x08], dword(DS_SEL)   ;SS0                 
    64 000000D3 C7400C00000000              mov [eax+0x0C], dword(0) ;ESP1
    65 000000DA C7401000000000              mov [eax+0x10], dword(0) ;SS1
    66 000000E1 C74014[00000000]            mov [eax+0x14], dword(__STACK_TASK2_VMA_END) ;ESP2
    67 000000E8 C74018[00000000]            mov [eax+0x18], dword(DS_SEL) ;SS2
    68 000000EF C7401C[00000000]            mov [eax+0x1C], dword(__CR3_TASK2);CR3
    69 000000F6 C74020[00000000]            mov [eax+0x20], dword(TASK2_LABEL) ;EIP
    70 000000FD C7402402020000              mov [eax+0x24], dword(EFLAGS) ;EFLAGS
    71 00000104 C7402800000000              mov [eax+0x28], dword(0) ;EAX
    72 0000010B C7402C00000000              mov [eax+0x2C], dword(0) ;ECX
    73 00000112 C7403000000000              mov [eax+0x30], dword(0) ;EDX
    74 00000119 C7403400000000              mov [eax+0x34], dword(0) ;EBX
    75 00000120 C74038[00000000]            mov [eax+0x38], dword(__STACK_TASK2_VMA_END) ;ESP
    76 00000127 C7403C[00000000]            mov [eax+0x3C], dword(__STACK_TASK2_VMA_END)    ;EBP
    77 0000012E C7404000000000              mov [eax+0x40], dword(0) ;ESI
    78 00000135 C7404400000000              mov [eax+0x44], dword(0) ;EDI
    79 0000013C C74048[00000000]            mov [eax+0x48], dword(DS_SEL) ;ES
    80 00000143 C7404C[00000000]            mov [eax+0x4C], dword(CS_SEL_32) ;CS
    81 0000014A C74050[00000000]            mov [eax+0x50], dword(DS_SEL) ;SS
    82 00000151 C74054[00000000]            mov [eax+0x54], dword(DS_SEL) ;DS
    83 00000158 C74058[00000000]            mov [eax+0x58], dword(DS_SEL) ;FS
    84 0000015F C7405C[00000000]            mov [eax+0x5C], dword(DS_SEL);GS
    85 00000166 C7406000000000              mov [eax+0x60], dword(0)   ;LDTR
    86 0000016D C7406400000000              mov [eax+0x64], dword(0) ;Bitmap I/O
    87                                  
    88                                  ;------------TSS TASK3------------
    89 00000174 B8[00000000]               mov eax, __TSS_TASK3
    90 00000179 C70000000000                mov [eax], dword(0) ;
    91 0000017F C74004[00000000]            mov [eax+0x04], dword(__STACK_END_32) ;ESP0
    92 00000186 C74008[00000000]            mov [eax+0x08], dword(DS_SEL)   ;SS0                 
    93 0000018D C7400C00000000              mov [eax+0x0C], dword(0) ;ESP1
    94 00000194 C7401000000000              mov [eax+0x10], dword(0) ;SS1
    95 0000019B C74014[00000000]            mov [eax+0x14], dword(__STACK_TASK3_VMA_END) ;ESP2
    96 000001A2 C74018[00000000]            mov [eax+0x18], dword(DS_SEL) ;SS2
    97 000001A9 C7401C[00000000]            mov [eax+0x1C], dword(__CR3_TASK3);CR3
    98 000001B0 C74020[00000000]            mov [eax+0x20], dword(TASK3_LABEL) ;EIP
    99 000001B7 C7402402020000              mov [eax+0x24], dword(EFLAGS) ;EFLAGS
   100 000001BE C7402800000000              mov [eax+0x28], dword(0) ;EAX
   101 000001C5 C7402C00000000              mov [eax+0x2C], dword(0) ;ECX
   102 000001CC C7403000000000              mov [eax+0x30], dword(0) ;EDX
   103 000001D3 C7403400000000              mov [eax+0x34], dword(0) ;EBX
   104 000001DA C74038[00000000]            mov [eax+0x38], dword(__STACK_TASK3_VMA_END) ;ESP
   105 000001E1 C7403C[00000000]            mov [eax+0x3C], dword(__STACK_TASK3_VMA_END)    ;EBP
   106 000001E8 C7404000000000              mov [eax+0x40], dword(0) ;ESI
   107 000001EF C7404400000000              mov [eax+0x44], dword(0) ;EDI
   108 000001F6 C74048[00000000]            mov [eax+0x48], dword(DS_SEL) ;ES
   109 000001FD C7404C[00000000]            mov [eax+0x4C], dword(CS_SEL_32) ;CS
   110 00000204 C74050[00000000]            mov [eax+0x50], dword(DS_SEL) ;SS
   111 0000020B C74054[00000000]            mov [eax+0x54], dword(DS_SEL) ;DS
   112 00000212 C74058[00000000]            mov [eax+0x58], dword(DS_SEL) ;FS
   113 00000219 C7405C[00000000]            mov [eax+0x5C], dword(DS_SEL);GS
   114 00000220 C7406000000000              mov [eax+0x60], dword(0)   ;LDTR
   115 00000227 C7406400000000              mov [eax+0x64], dword(0) ;Bitmap I/O         
   116                                  
   117                                  ;------------TSS TASK4------------
   118 0000022E B8[00000000]               mov eax, __TSS_TASK4
   119 00000233 C70000000000                mov [eax], dword(0) ;
   120 00000239 C74004[00000000]            mov [eax+0x04], dword(__STACK_END_32) ;ESP0
   121 00000240 C74008[00000000]            mov [eax+0x08], dword(DS_SEL)   ;SS0                 
   122 00000247 C7400C00000000              mov [eax+0x0C], dword(0) ;ESP1
   123 0000024E C7401000000000              mov [eax+0x10], dword(0) ;SS1
   124 00000255 C74014[00000000]            mov [eax+0x14], dword(__STACK_TASK4_VMA_END) ;ESP2
   125 0000025C C74018[00000000]            mov [eax+0x18], dword(DS_SEL) ;SS2
   126 00000263 C7401C[00000000]            mov [eax+0x1C], dword(__CR3_TASK4);CR3
   127 0000026A C74020[00000000]            mov [eax+0x20], dword(TASK4_LABEL) ;EIP
   128 00000271 C7402402020000              mov [eax+0x24], dword(EFLAGS) ;EFLAGS
   129 00000278 C7402800000000              mov [eax+0x28], dword(0) ;EAX
   130 0000027F C7402C00000000              mov [eax+0x2C], dword(0) ;ECX
   131 00000286 C7403000000000              mov [eax+0x30], dword(0) ;EDX
   132 0000028D C7403400000000              mov [eax+0x34], dword(0) ;EBX
   133 00000294 C7403800000000              mov [eax+0x38], dword(0) ;ESP
   134 0000029B C7403C00000000              mov [eax+0x3C], dword(0) ;EBP
   135 000002A2 C7404000000000              mov [eax+0x40], dword(0) ;ESI
   136 000002A9 C7404400000000              mov [eax+0x44], dword(0) ;EDI
   137 000002B0 C74048[00000000]            mov [eax+0x48], dword(DS_SEL) ;ES
   138 000002B7 C7404C[00000000]            mov [eax+0x4C], dword(CS_SEL_32) ;CS
   139 000002BE C74050[00000000]            mov [eax+0x50], dword(DS_SEL) ;SS
   140 000002C5 C74054[00000000]            mov [eax+0x54], dword(DS_SEL) ;DS
   141 000002CC C74058[00000000]            mov [eax+0x58], dword(DS_SEL) ;FS
   142 000002D3 C7405C[00000000]            mov [eax+0x5C], dword(DS_SEL);GS
   143 000002DA C7406000000000              mov [eax+0x60], dword(0)   ;LDTR
   144 000002E1 C7406400000000              mov [eax+0x64], dword(0) ;Bitmap I/O
   145                                  
   146                                  ;------------TSS KERNEL------------
   147 000002E8 B8[00000000]               mov eax, __TSS_KERNEL
   148 000002ED C70000000000                mov [eax], dword(0) ;
   149 000002F3 C74004[00000000]            mov [eax+0x04], dword(__STACK_END_32) ;ESP0
   150 000002FA C74008[00000000]            mov [eax+0x08], dword(DS_SEL)   ;SS0                 
   151 00000301 C7400C00000000              mov [eax+0x0C], dword(0) ;ESP1
   152 00000308 C7401000000000              mov [eax+0x10], dword(0) ;SS1
   153 0000030F C74014[00000000]            mov [eax+0x14], dword(__STACK_END_32) ;ESP2
   154 00000316 C74018[00000000]            mov [eax+0x18], dword(DS_SEL) ;SS2
   155 0000031D C7401C[00000000]            mov [eax+0x1C], dword(__CR3_KERNEL);CR3
   156 00000324 C74020[00000000]            mov [eax+0x20], dword(kernel32_loop) ;EIP
   157 0000032B C7402402020000              mov [eax+0x24], dword(EFLAGS) ;EFLAGS
   158 00000332 C7402800000000              mov [eax+0x28], dword(0) ;EAX
   159 00000339 C7402C00000000              mov [eax+0x2C], dword(0) ;ECX
   160 00000340 C7403000000000              mov [eax+0x30], dword(0) ;EDX
   161 00000347 C7403400000000              mov [eax+0x34], dword(0) ;EBX
   162 0000034E C7403800000000              mov [eax+0x38], dword(0) ;ESP
   163 00000355 C7403C00000000              mov [eax+0x3C], dword(0) ;EBP
   164 0000035C C7404000000000              mov [eax+0x40], dword(0) ;ESI
   165 00000363 C7404400000000              mov [eax+0x44], dword(0) ;EDI
   166 0000036A C74048[00000000]            mov [eax+0x48], dword(DS_SEL) ;ES
   167 00000371 C7404C[00000000]            mov [eax+0x4C], dword(CS_SEL_32) ;CS
   168 00000378 C74050[00000000]            mov [eax+0x50], dword(DS_SEL) ;SS
   169 0000037F C74054[00000000]            mov [eax+0x54], dword(DS_SEL) ;DS
   170 00000386 C74058[00000000]            mov [eax+0x58], dword(DS_SEL) ;FS
   171 0000038D C7405C[00000000]            mov [eax+0x5C], dword(DS_SEL);GS
   172 00000394 C7406000000000              mov [eax+0x60], dword(0)   ;LDTR
   173 0000039B C7406400000000              mov [eax+0x64], dword(0) ;Bitmap I/O
   174 000003A2 31C0                        xor eax, eax
   175 000003A4 66B8[0000]                  mov ax, TSS_SEL
   176 000003A8 0F00D8                      ltr ax ; Load TSS
   177                                  
   178                                  
   179                                  
   180 000003AB C3                          ret
